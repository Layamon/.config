# ===================================================================
# 终端设置
# 配置 tmux 使用的终端类型，确保正确的颜色和功能支持
# ===================================================================
set -g default-terminal "screen-256color"
if 'infocmp -x tmux-256color > /dev/null 2>&1' 'set -g default-terminal "tmux-256color"'

# ===================================================================
# 跨平台路径配置
# 自动识别操作系统，设置配置文件目录路径
# ===================================================================
# macOS 平台
if-shell "uname | grep -q Darwin" \
  "set-environment -g TMUX_CONFIG_DIR '/Users/layamon/.config/tmux'" \
  "set-environment -g TMUX_CONFIG_DIR '/home/liuyangming/.config/tmux'"

# ===================================================================
# 插件管理
# 使用 TPM (Tmux Plugin Manager) 管理插件
# ===================================================================
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'catppuccin/tmux#v2.1.3'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# ===================================================================
# 剪贴板集成
# 启用 OSC 52 序列，支持与系统剪贴板双向同步
# ===================================================================
# support OSC 52, bind tmux with system clipboard
set -g set-clipboard on
set -g terminal-overrides 'xterm*:Ms=\E]52;c;%p1%s\a'

# ===================================================================
# 键盘和性能优化
# 减少按键延迟，启用焦点事件，提升响应速度
# ===================================================================
setw -g xterm-keys on
set -s escape-time 10                     # faster command sequences
set -sg repeat-time 600                   # increase repeat timeout
set -s focus-events on

# ===================================================================
# 光标样式
# 根据模式自动切换光标形状（块状/下划线/竖线）
# ===================================================================
set -ga terminal-overrides '*:Ss=\E[%p1%d q:Se=\E[ q'

# ===================================================================
# 编码设置
# 确保 UTF-8 字符正确显示
# ===================================================================
set -q -g status-utf8 on                  # expect UTF-8 (tmux < 2.2)
setw -q -g utf8 on

# ===================================================================
# 历史记录
# 设置窗口回滚缓冲区大小，保存更多历史输出
# ===================================================================
set -g history-limit 7000                 # boost history

# ===================================================================
# 快捷键：重载配置
# 按 Prefix + r 快速重新加载配置文件，无需重启 tmux
# ===================================================================
bind r source-file ~/.config/tmux/tmux.conf \; display '~/.config/tmux/tmux.conf sourced'

# ===================================================================
# 显示设置
# 窗口和面板编号从 1 开始（更符合键盘布局）
# 自动重命名窗口反映当前程序
# 关闭窗口时自动重新编号
# ===================================================================
set -g base-index 1           # start windows numbering at 1
setw -g pane-base-index 1     # make pane numbering consistent with windows

setw -g automatic-rename on   # rename window to reflect current program
set -g renumber-windows on    # renumber windows when a window is closed

set -g set-titles on          # set terminal title

set -g display-panes-time 800 # slightly longer pane indicators display time
set -g display-time 1000      # slightly longer status messages display time

set -g status-interval 10     # redraw status line every 10 seconds

# ===================================================================
# 活动监控
# 监控其他窗口/面板的活动
# ===================================================================
set -g monitor-activity on
set -g visual-activity off

# ===================================================================
# 导航和复制模式
# Vim 风格的键绑定：
#   - Prefix + [ 进入复制模式
#   - v 开始选择，C-v 块选择，y 复制
#   - hjkl 导航面板
#   - - 水平分割，_ 垂直分割
#   - Tab 切换到最近使用的窗口
# ===================================================================
setw -g mode-keys vi
bind -T copy-mode-vi v      send -X begin-selection
bind -T copy-mode-vi C-v    send -X rectangle-toggle
bind -T copy-mode-vi y      send -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send -X cancel
bind -T copy-mode-vi L      send -X end-of-line
bind -T copy-mode-vi H      send -X start-of-line
# create session
bind C-c new-session

# split current window horizontally
unbind %
bind - split-window -v -c "#{pane_current_path}"
# split current window vertically
unbind '"'
bind _ split-window -h -c "#{pane_current_path}"

# pane navigation
bind -r h select-pane -L  # move left
bind -r j select-pane -D  # move down
bind -r k select-pane -U  # move up
bind -r l select-pane -R  # move right
bind > swap-pane -D       # swap current pane with the next one
bind < swap-pane -U       # swap current pane with the previous one

bind Tab last-window        # move to last active window

# theme
set -g @catppuccin_flavor 'latte' # latte, frappe, macchiato or mocha
# 设置 window 标签显示当前目录名
set -g @catppuccin_window_text " #I #{b:pane_current_path}"
set -g @catppuccin_window_current_text " #I #{b:pane_current_path}"
set -g @catppuccin_window_status_style "rounded"

set -g status-right-length 100
set -g status-left-length 100
set -g status-left ""
# ===================================================================
# 会话保存和恢复 (tmux-resurrect + tmux-continuum)
# ===================================================================
# resurrect 配置
set -g @resurrect-capture-pane-contents 'on'       # 保存 pane 内容
set -g @resurrect-strategy-vim 'session'           # 保存 vim 会话
set -g @resurrect-strategy-nvim 'session'          # 保存 neovim 会话
set -g @resurrect-save-shell-history 'on'          # 保存 shell 历史
set -g @resurrect-save-command-history 'on'        # 保存命令历史

# continuum 配置
set -g @continuum-restore 'on'                      # 启动时自动恢复
set -g @continuum-save-interval '15'                # 每15分钟自动保存
set -g @continuum-boot 'on'                         # 系统启动时自动启动 tmux
set -g @continuum-boot-options 'iterm'              # 启动选项
set -g status-right "#{E:@catppuccin_status_application}"
set -ag status-left "#{E:@catppuccin_status_session}"
set -ag status-right "#{E:@catppuccin_status_uptime}"

# ===================================================================
# 本地配置覆盖
# 加载用户自定义配置（如果存在）
# 可以在这里添加个性化设置，覆盖默认配置
# ===================================================================
# -- user defined overrides ----------------------------------------------------
#source -q ~/.config/tmux/tmux.conf.local

# ===================================================================
# 插件管理器初始化
# 必须放在配置文件最后一行
# 安装插件：按 Prefix + I
# 更新插件：按 Prefix + U
# ===================================================================
# 加载 Catppuccin 主题（必须在 TPM 初始化之前）
# 确保 Latte 主题颜色正确应用
set-environment -g @catppuccin_flavor "latte"

run "#{TMUX_CONFIG_DIR}/plugins/catppuccin/tmux/catppuccin.tmux"
# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '#{TMUX_CONFIG_DIR}/plugins/tpm/tpm'

